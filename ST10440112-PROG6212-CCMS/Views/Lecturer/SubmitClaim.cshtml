@model ST10440112_PROG6212_CCMS.Models.Claim

@{
    ViewData["Title"] = "Submit Claim";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-file-earmark-plus"></i> Submit New Claim</h2>
            <p class="text-muted">Enter your hours worked and submit for review</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="@Url.Action("Dashboard", "Lecturer")" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="SubmitClaim" method="post" novalidate enctype="multipart/form-data">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> <strong>Your Hourly Rate:</strong> R <strong>@Model.HourlyRate.ToString("N2")</strong>
                            <br>
                            <small>This rate is automatically applied to your claim calculation.</small>
                        </div>

                        <input type="hidden" asp-for="LecturerId" />
                        <input type="hidden" asp-for="HourlyRate" />
                        <input type="hidden" asp-for="ClaimStatus" />
                        <input type="hidden" asp-for="SubmissionDate" />

                        <div class="mb-3">
                            <label asp-for="ClaimDate" class="form-label">Claim Date *</label>
                            <input type="date" class="form-control"
                                   asp-for="ClaimDate" required>
                            <span class="text-danger small" asp-validation-for="ClaimDate"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="TotalHours" class="form-label">Total Hours Worked *</label>
                            <div class="input-group">
                                <input type="number" class="form-control"
                                       asp-for="TotalHours" step="0.5" min="0" max="160" placeholder="e.g., 20.5" required>
                                <span class="input-group-text">hours</span>
                            </div>
                            <small class="text-muted">Range: 0 - 160 hours</small>
                            <span class="text-danger small d-block" asp-validation-for="TotalHours"></span>
                        </div>

                        <div class="card mb-3" style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <h6 class="card-title">Claim Calculation</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <p class="mb-1"><small class="text-muted">Hourly Rate (Fixed):</small></p>
                                        <p id="hourlyRateDisplay" style="font-weight: 600;">R @Model.HourlyRate.ToString("N2")</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><small class="text-muted">Hours Worked:</small></p>
                                        <p id="hoursDisplay" style="font-weight: 600;">0.0</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><small class="text-muted"><strong>Total Amount:</strong></small></p>
                                        <p id="totalAmountDisplay" style="font-size: 1.25rem; color: #13325B; font-weight: 600;">R 0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="documents" class="form-label">Supporting Documents (Optional)</label>
                            <input type="file" class="form-control" id="documents" name="documents" multiple accept=".pdf,.docx,.xlsx" aria-describedby="documentsHelp">
                            <small id="documentsHelp" class="form-text text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> Accepted formats: PDF, DOCX, XLSX (Max 10MB per file) - Files will be encrypted before upload
                            </small>
                            <div id="fileList" class="mt-3">
                                <div id="encryptionInfo" style="display: none;" class="alert alert-info alert-sm d-flex align-items-center gap-2 mb-2">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Processing...</span>
                                    </div>
                                    <span id="encryptionStatus">Preparing files for encryption...</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Submit Claim
                            </button>
                            <a href="@Url.Action("Dashboard", "Lecturer")" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #13325B; color: white;">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>Enter Your Hours:</strong> Input the total number of hours you worked during the claim period.
                        </li>
                        <li class="mb-2">
                            <strong>Review Calculation:</strong> Your total amount will be calculated automatically.
                        </li>
                        <li class="mb-2">
                            <strong>Add Documents:</strong> Optionally upload supporting documents (PDF, DOCX, XLSX). Documents are encrypted with AES-256 for security.
                        </li>
                        <li class="mb-2">
                            <strong>Submit for Review:</strong> Once submitted, your claim will be reviewed by the coordinator.
                        </li>
                        <li>
                            <strong>Track Status:</strong> Check the status of your claims from your dashboard.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hourlyRate = @Model.HourlyRate;
        const totalHoursInput = document.querySelector('[name="TotalHours"]');
        const documentsInput = document.getElementById('documents');
        const fileList = document.getElementById('fileList');

        function updateCalculation() {
            const hours = parseFloat(totalHoursInput.value) || 0;
            const total = hours * hourlyRate;

            // Update display fields
            document.getElementById('hoursDisplay').textContent = hours.toFixed(1);
            document.getElementById('totalAmountDisplay').textContent = 'R ' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function updateFileList() {
            const encryptionInfo = document.getElementById('encryptionInfo');
            const encryptionStatus = document.getElementById('encryptionStatus');

            // Clear previous list but keep encryption info div
            const existingList = fileList.querySelector('ul');
            if (existingList) {
                existingList.remove();
            }

            if (documentsInput.files.length > 0) {
                // Show encryption status
                encryptionInfo.style.display = 'flex';
                encryptionStatus.textContent = `Preparing ${documentsInput.files.length} file(s) for encryption...`;

                const ul = document.createElement('ul');
                ul.className = 'list-group mt-2';

                for (let i = 0; i < documentsInput.files.length; i++) {
                    const file = documentsInput.files[i];
                    const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);

                    // Simulate encryption processing
                    const processDelay = (i + 1) * 300; // Staggered processing

                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.id = `file-${i}`;
                    li.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start gap-3">
                            <div>
                                <i class="bi bi-file-earmark"></i> <strong>${file.name}</strong>
                                <br />
                                <small class="text-muted">${sizeInMB} MB</small>
                            </div>
                            <div class="d-flex align-items-center gap-2 ms-auto">
                                <span class="badge bg-secondary" style="font-size: 0.8rem;">
                                    <i class="bi bi-hourglass-split"></i> Pending
                                </span>
                            </div>
                        </div>
                    `;
                    ul.appendChild(li);

                    // Simulate encryption status update
                    setTimeout(() => {
                        const badge = li.querySelector('.badge');
                        if (badge) {
                            badge.innerHTML = '<i class="bi bi-shield-check"></i> Encrypted';
                            badge.className = 'badge bg-success';
                        }

                        // Update main encryption status
                        const completedCount = document.querySelectorAll('.badge.bg-success').length;
                        if (completedCount === documentsInput.files.length) {
                            encryptionStatus.textContent = `All ${documentsInput.files.length} file(s) ready for upload (AES-256 encrypted)`;
                        } else {
                            encryptionStatus.textContent = `Encrypting... ${completedCount} of ${documentsInput.files.length} file(s) encrypted`;
                        }
                    }, processDelay);
                }

                fileList.appendChild(ul);
            } else {
                encryptionInfo.style.display = 'none';
            }
        }

        totalHoursInput.addEventListener('input', updateCalculation);
        documentsInput.addEventListener('change', updateFileList);
        updateCalculation();
    });
</script>
